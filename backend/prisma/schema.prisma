generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     Int       @id @default(autoincrement())
  username               String?
  lastName               String?
  middleName             String?
  token                  String?
  email                  String    @unique
  password               String
  phoneNumber            String?   @unique
  group                  Int?
  createdAt              DateTime  @default(now())
  nrc_card_id            String?
  role                   UserRole  @default(GUARDIAN_PARENT)
  isEmailVerified        Boolean   @default(false)
  emailVerificationToken String?
  bloodGroup             String?
  address                String?
  premium                String?
  dateOfBirth            DateTime?
  gender                 String?
  emergencyContact       String?
  videos                 videos[]  @relation("VideoUploader")
  images                 images[]  @relation("ImageUploader")
  tests                  Test[]    @relation("TestCreator")
  quizImages            QuizImage[] @relation("QuizImageUploader")
  //  usedPromoCodes        UsedPromoCode[] @relation("UserUsedPromoCodes")

  Lesson Lesson[]

  premiumBalance   Float    @default(0)
  premiumActive    Boolean  @default(false)
  premiumDeduction Float    @default(0)
  premiumExpiry    DateTime?
  trialStartDate   DateTime?
  trialExpiry      DateTime?
  isTrialUsed      Boolean  @default(false)

  UsedPromoCode UsedPromoCode[] @relation("UserUsedPromoCodes")
}

model SystemSettings {
  id                Int      @id @default(autoincrement())
  companyName       String   @default("Book8 Learning Platform")
  adminEmail        String   @default("admin@book8.com")
  premiumPricing    String   @default("50") // Default premium pricing
  notificationEmail String   @default("notifications@book8.com")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model videos {
  id               Int      @id @default(autoincrement())
  linkyoutube_link String?
  video_url        String?  // R2 video URL (optional)
  title            String
  category         String?
  position         Int?
  description      String?
  ageGroup         String?
  name             String?
  userId           Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  userUploader     User?    @relation(fields: [userId], references: [id], name: "VideoUploader")
}

model images {
  id           Int      @id @default(autoincrement())
  imageUrl     String   // URL where the image is stored
  title        String
  thumbnail    String?  // Optional thumbnail for preview
  category     String?
  position     Int?     // For ordering images in a sequence
  description  String?
  ageGroup     String?  // To match the content with age groups
  name         String?
  userId       Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userUploader User?    @relation(fields: [userId], references: [id], name: "ImageUploader")
}

model Test {
  id          Int       @id @default(autoincrement())
  title       String
  description String?
  subject     String
  ageGroup    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   User      @relation("TestCreator", fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  questions   Question[]
}

model Question {
  id              Int          @id @default(autoincrement())
  questionType    QuestionType @default(TEXT)
  questionText    String
  questionMediaUrl String?
  explanation     String?
  difficulty      String?      @default("easy")
  test           Test         @relation(fields: [testId], references: [id], onDelete: Cascade)
  testId         Int
  choices        Choice[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Choice {
  id             Int        @id @default(autoincrement())
  choiceType     ChoiceType @default(TEXT)
  choiceText     String?
  choiceMediaUrl String?
  isCorrect      Boolean    @default(false)
  question       Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  questionId     Int
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model QuizImage {
  id          Int      @id @default(autoincrement())
  imageUrl    String   // URL where the image is stored
  name        String   // Name of the object/item in the image
  category    String   // Category like animals, fruits, vehicles, etc.
  ageGroup    String   // Age group this image is appropriate for
  isActive    Boolean  @default(true)
  quizTypes   String[]  // Array of quiz types: ['true_false', 'image_quiz']
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
    userId      Int?
  uploader    User?    @relation("QuizImageUploader", fields: [userId], references: [id])
  @@index([category])
  @@index([ageGroup])
}

model PromoCode {
  id          Int       @id @default(autoincrement())
  code        String    @unique
  discount    Float     // Percentage discount (e.g., 10.0 for 10%)
  maxUses     Int       // Maximum number of times this code can be used
  usedCount   Int       @default(0)
  validFrom   DateTime  @default(now())
  validUntil  DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  usedBy      UsedPromoCode[]
}

model UsedPromoCode {
  id          Int       @id @default(autoincrement())
  promoCode   PromoCode @relation(fields: [promoCodeId], references: [id])
  promoCodeId Int
  user        User      @relation("UserUsedPromoCodes", fields: [userId], references: [id])
  userId      Int
  usedAt      DateTime  @default(now())
  amountSaved Float     // Amount saved by using this promo code

  @@unique([promoCodeId, userId]) // Each user can only use a promo code once
}

enum UserRole {
  ADMIN
  SUPERUSER
  INSPECTOR
  STUDENT
  
  TEACHER
  GUARDIAN_PARENT
  FINANCE
}

enum QuestionType {
  TEXT
  IMAGE
  VIDEO
}

enum ChoiceType {
  TEXT
  IMAGE
  VIDEO
}



model Lesson {
  id          Int    @id @default(autoincrement())
  title       String
  description String?
  subject     String  //{wants_and_needs_expression ,action_words_and_verbs, what_questions, where_questions, who_questions, when_questions, why_questions}
  ageGroup    String
  statement   String  // JSON object with structure: { type: "text" | "image_url" | "YOUTUBE-video_url", content: string }
  options     Json    // Array of objects with structure: [{ type: "text" | "image_url" | "video_url", content: string }]
  userId      Int
  
  createdBy User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

}